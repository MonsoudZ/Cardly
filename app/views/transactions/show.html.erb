<div class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <!-- Back Link -->
  <div class="mb-6">
    <%= link_to transactions_path, class: "inline-flex items-center text-gray-600 hover:text-rose-600" do %>
      <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
      </svg>
      Back to Transactions
    <% end %>
  </div>

  <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
    <div class="p-6">
      <!-- Status Badge -->
      <div class="flex justify-between items-start mb-6">
        <h1 class="text-2xl font-bold text-gray-900">
          <% if @transaction.sale? %>Purchase<% else %>Trade<% end %> Offer
        </h1>
        <span class="px-3 py-1 rounded-full text-sm font-medium
          <%= case @transaction.status
              when 'pending' then 'bg-amber-100 text-amber-800'
              when 'accepted', 'completed' then 'bg-green-100 text-green-800'
              when 'rejected' then 'bg-red-100 text-red-800'
              when 'cancelled' then 'bg-gray-100 text-gray-800'
              end %>">
          <%= @transaction.status.capitalize %>
        </span>
      </div>

      <!-- Card Being Purchased/Traded -->
      <div class="bg-gray-50 rounded-lg p-4 mb-6">
        <p class="text-sm text-gray-500 mb-2">Card</p>
        <div class="flex items-center space-x-4">
          <img src="<%= @transaction.listing.brand_display_logo %>" alt="" class="w-16 h-10 object-contain rounded bg-white p-2">
          <div>
            <p class="font-semibold text-gray-900"><%= @transaction.brand_name %> Gift Card</p>
            <p class="text-lg font-bold text-gray-900"><%= number_to_currency(@transaction.listing.balance) %> value</p>
          </div>
        </div>
      </div>

      <% if @transaction.sale? %>
        <!-- Sale Details -->
        <div class="space-y-4 mb-6">
          <div class="flex justify-between py-3 border-b border-gray-100">
            <span class="text-gray-600">Purchase Price</span>
            <span class="font-semibold text-gray-900"><%= number_to_currency(@transaction.amount) %></span>
          </div>
          <% if @transaction.listing.discount_percentage.present? && @transaction.listing.discount_percentage > 0 %>
            <div class="flex justify-between py-3 border-b border-gray-100">
              <span class="text-gray-600">Savings</span>
              <span class="font-semibold text-green-600"><%= @transaction.listing.discount_percentage %>% off</span>
            </div>
          <% end %>
        </div>
      <% else %>
        <!-- Trade Details -->
        <div class="bg-blue-50 rounded-lg p-4 mb-6">
          <p class="text-sm text-blue-600 mb-2">Offered in Trade</p>
          <div class="flex items-center space-x-4">
            <img src="<%= @transaction.offered_gift_card.brand_display_logo %>" alt="" class="w-16 h-10 object-contain rounded bg-white p-2">
            <div>
              <p class="font-semibold text-gray-900"><%= @transaction.offered_gift_card.brand_name %> Gift Card</p>
              <p class="text-lg font-bold text-gray-900"><%= number_to_currency(@transaction.offered_gift_card.balance) %> value</p>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Message -->
      <% if @transaction.message.present? %>
        <div class="mb-6">
          <p class="text-sm text-gray-500 mb-2">Message from <%= @transaction.buyer.display_name %></p>
          <p class="text-gray-700 bg-gray-50 p-4 rounded-lg"><%= @transaction.message %></p>
        </div>
      <% end %>

      <!-- Parties -->
      <div class="grid grid-cols-2 gap-4 mb-6 pt-6 border-t border-gray-100">
        <div>
          <p class="text-sm text-gray-500 mb-2">Buyer</p>
          <%= link_to user_path(@transaction.buyer), class: "flex items-center group" do %>
            <img class="h-8 w-8 rounded-full object-cover" src="<%= @transaction.buyer.avatar.presence || 'https://placehold.co/32?text=' + @transaction.buyer.display_name.first.upcase %>" alt="" />
            <span class="ml-2 font-medium text-gray-900 group-hover:text-rose-600"><%= @transaction.buyer.display_name %></span>
            <% if @transaction.buyer.average_rating %>
              <span class="ml-2 flex items-center text-sm text-gray-500">
                <svg class="w-4 h-4 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                </svg>
                <span class="ml-0.5"><%= @transaction.buyer.average_rating %></span>
              </span>
            <% end %>
          <% end %>
        </div>
        <div>
          <p class="text-sm text-gray-500 mb-2">Seller</p>
          <%= link_to user_path(@transaction.seller), class: "flex items-center group" do %>
            <img class="h-8 w-8 rounded-full object-cover" src="<%= @transaction.seller.avatar.presence || 'https://placehold.co/32?text=' + @transaction.seller.display_name.first.upcase %>" alt="" />
            <span class="ml-2 font-medium text-gray-900 group-hover:text-rose-600"><%= @transaction.seller.display_name %></span>
            <% if @transaction.seller.average_rating %>
              <span class="ml-2 flex items-center text-sm text-gray-500">
                <svg class="w-4 h-4 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                </svg>
                <span class="ml-0.5"><%= @transaction.seller.average_rating %></span>
              </span>
            <% end %>
          <% end %>
        </div>
      </div>

      <!-- Actions -->
      <% if @transaction.pending? %>
        <div class="pt-6 border-t border-gray-100">
          <% if @transaction.seller == current_user %>
            <p class="text-sm text-gray-500 mb-4">You received this offer. Accept to complete the transaction.</p>
            <div class="flex space-x-3">
              <%= button_to accept_transaction_path(@transaction), method: :post, class: "flex-1 inline-flex items-center justify-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-500 font-medium" do %>
                Accept Offer
              <% end %>
              <%= button_to reject_transaction_path(@transaction), method: :post, class: "flex-1 inline-flex items-center justify-center px-4 py-2 border border-red-300 text-red-700 rounded-lg hover:bg-red-50 font-medium", data: { turbo_confirm: "Are you sure you want to reject this offer?" } do %>
                Reject
              <% end %>
            </div>
          <% else %>
            <p class="text-sm text-gray-500 mb-4">Waiting for <%= @transaction.seller.display_name %> to respond.</p>
            <%= button_to cancel_transaction_path(@transaction), method: :post, class: "w-full inline-flex items-center justify-center px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium", data: { turbo_confirm: "Are you sure you want to cancel this offer?" } do %>
              Cancel Offer
            <% end %>
          <% end %>
        </div>
      <% end %>

      <!-- Timestamp -->
      <div class="mt-6 pt-6 border-t border-gray-100 text-sm text-gray-500">
        Created <%= time_ago_in_words(@transaction.created_at) %> ago
        <% if @transaction.completed? %>
          &middot; Completed <%= time_ago_in_words(@transaction.updated_at) %> ago
        <% end %>
      </div>

      <!-- Messages Section -->
      <div class="mt-6 pt-6 border-t border-gray-100" id="messages">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-semibold text-gray-900">
            Messages
            <% if @transaction.messages.any? %>
              <span class="text-sm font-normal text-gray-500">(<span id="message_count"><%= @transaction.messages.count %></span>)</span>
            <% end %>
          </h3>
          <% unread_count = @transaction.unread_message_count_for(current_user) %>
          <% if unread_count > 0 %>
            <span class="px-2 py-1 bg-rose-100 text-rose-700 text-xs font-medium rounded-full">
              <%= unread_count %> new
            </span>
          <% end %>
        </div>

        <% if @transaction.messages.any? %>
          <div id="messages" class="space-y-3 max-h-80 overflow-y-auto mb-4 p-2">
            <% @transaction.messages.chronological.each do |message| %>
              <%= render partial: "messages/message", locals: { message: message, current_user: current_user } %>
            <% end %>
          </div>
          <% @transaction.mark_messages_read_for!(current_user) %>
        <% else %>
          <p class="text-sm text-gray-500 mb-4">No messages yet. Start the conversation!</p>
        <% end %>

        <%= render partial: "messages/form", locals: { transaction: @transaction, message: @transaction.messages.build } %>
      </div>

      <% if @transaction.completed? %>
        <!-- Ratings Section -->
        <div class="mt-6 pt-6 border-t border-gray-100">
          <h3 class="font-semibold text-gray-900 mb-4">Ratings</h3>

          <% if @transaction.can_be_rated_by?(current_user) %>
            <div class="bg-rose-50 border border-rose-100 rounded-lg p-4 mb-4">
              <p class="text-sm text-rose-800 mb-3">Share your experience with this transaction.</p>
              <%= link_to new_transaction_rating_path(@transaction), class: "inline-flex items-center px-4 py-2 bg-rose-600 text-white rounded-lg hover:bg-rose-500 font-medium text-sm" do %>
                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                </svg>
                Rate this Transaction
              <% end %>
            </div>
          <% end %>

          <% if @transaction.ratings.any? %>
            <div class="space-y-4">
              <% @transaction.ratings.includes(:rater, :ratee).each do |rating| %>
                <div class="bg-gray-50 rounded-lg p-4">
                  <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center">
                      <%= link_to rating.rater.display_name, user_path(rating.rater), class: "font-medium text-gray-900 hover:text-rose-600" %>
                      <span class="mx-2 text-gray-400">rated</span>
                      <%= link_to rating.ratee.display_name, user_path(rating.ratee), class: "font-medium text-gray-900 hover:text-rose-600" %>
                    </div>
                    <div class="flex items-center">
                      <% rating.score.times do %>
                        <svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                          <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                        </svg>
                      <% end %>
                      <% (5 - rating.score).times do %>
                        <svg class="w-5 h-5 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                          <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                        </svg>
                      <% end %>
                    </div>
                  </div>
                  <% if rating.comment.present? %>
                    <p class="text-gray-600 text-sm"><%= rating.comment %></p>
                  <% end %>
                  <p class="text-xs text-gray-400 mt-2"><%= time_ago_in_words(rating.created_at) %> ago</p>
                </div>
              <% end %>
            </div>
          <% else %>
            <p class="text-sm text-gray-500">No ratings yet.</p>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>
