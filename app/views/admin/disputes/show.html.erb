<% content_for :page_title, "Dispute ##{@dispute.id}" %>

<div class="mb-6">
  <%= link_to admin_disputes_path, class: "inline-flex items-center text-gray-500 hover:text-gray-700" do %>
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
    </svg>
    Back to Disputes
  <% end %>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
  <!-- Main Content -->
  <div class="lg:col-span-2 space-y-6">
    <!-- Dispute Details -->
    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex justify-between items-start mb-4">
        <div>
          <h1 class="text-xl font-bold text-gray-900">Dispute #<%= @dispute.id %></h1>
          <p class="text-sm text-gray-500"><%= @dispute.reason_display %></p>
        </div>
        <% case @dispute.status %>
        <% when "open" %>
          <span class="px-3 py-1 text-sm font-medium rounded-full bg-yellow-100 text-yellow-800">Open</span>
        <% when "under_review" %>
          <span class="px-3 py-1 text-sm font-medium rounded-full bg-blue-100 text-blue-800">Under Review</span>
        <% when "resolved" %>
          <span class="px-3 py-1 text-sm font-medium rounded-full bg-green-100 text-green-800">Resolved</span>
        <% when "closed" %>
          <span class="px-3 py-1 text-sm font-medium rounded-full bg-gray-100 text-gray-800">Closed</span>
        <% end %>
      </div>

      <div class="border-t border-gray-100 pt-4">
        <h3 class="text-sm font-medium text-gray-700 mb-2">Description</h3>
        <p class="text-gray-600 whitespace-pre-wrap"><%= @dispute.description %></p>
      </div>

      <div class="border-t border-gray-100 pt-4 mt-4">
        <h3 class="text-sm font-medium text-gray-700 mb-2">Timeline</h3>
        <div class="space-y-2 text-sm">
          <p class="text-gray-600">
            <span class="font-medium">Created:</span> <%= @dispute.created_at.strftime("%B %d, %Y at %I:%M %p") %>
          </p>
          <% if @dispute.reviewed_at.present? %>
            <p class="text-gray-600">
              <span class="font-medium">Under Review:</span> <%= @dispute.reviewed_at.strftime("%B %d, %Y at %I:%M %p") %>
            </p>
          <% end %>
          <% if @dispute.resolved_at.present? %>
            <p class="text-gray-600">
              <span class="font-medium">Resolved:</span> <%= @dispute.resolved_at.strftime("%B %d, %Y at %I:%M %p") %>
              (<%= @dispute.resolution_display %>)
            </p>
          <% end %>
          <% if @dispute.closed_at.present? %>
            <p class="text-gray-600">
              <span class="font-medium">Closed:</span> <%= @dispute.closed_at.strftime("%B %d, %Y at %I:%M %p") %>
            </p>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Messages -->
    <div class="bg-white rounded-lg shadow">
      <div class="p-4 border-b border-gray-100">
        <h2 class="text-lg font-semibold text-gray-900">Messages</h2>
      </div>
      <div class="divide-y divide-gray-100 max-h-96 overflow-y-auto">
        <% if @messages.empty? %>
          <div class="p-8 text-center text-gray-500">
            <p>No messages yet.</p>
          </div>
        <% else %>
          <% @messages.each do |message| %>
            <div class="p-4 <%= message.from_admin? ? 'bg-purple-50' : '' %>">
              <div class="flex justify-between items-start mb-2">
                <div class="flex items-center space-x-2">
                  <span class="font-medium text-gray-900"><%= message.sender.display_name %></span>
                  <% if message.from_admin? %>
                    <span class="px-2 py-0.5 text-xs font-medium rounded-full bg-purple-100 text-purple-800">Admin</span>
                  <% elsif message.sender == @dispute.initiator %>
                    <span class="px-2 py-0.5 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800">Initiator</span>
                  <% end %>
                </div>
                <span class="text-xs text-gray-400"><%= message.created_at.strftime("%b %d, %I:%M %p") %></span>
              </div>
              <p class="text-gray-600"><%= message.content %></p>
            </div>
          <% end %>
        <% end %>
      </div>
      <div class="p-4 border-t border-gray-100 bg-gray-50">
        <%= form_with url: add_message_admin_dispute_path(@dispute), method: :post do |f| %>
          <%= f.text_area :dispute_message, :content,
              class: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-rose-500 focus:border-rose-500 min-h-[80px] mb-2",
              placeholder: "Type admin message..." %>
          <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-500">
            Send as Admin
          </button>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="space-y-6">
    <!-- Transaction Info -->
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Transaction</h2>
      <div class="flex items-center space-x-3 mb-4">
        <img src="<%= @transaction.gift_card.brand_display_logo %>" alt="" class="w-12 h-8 object-contain rounded bg-gray-50 p-1">
        <div>
          <p class="font-medium text-gray-900"><%= @transaction.gift_card.brand_name %></p>
          <p class="text-sm text-gray-500">
            Balance: <%= number_to_currency(@transaction.gift_card.balance) %>
          </p>
        </div>
      </div>
      <div class="space-y-2 text-sm">
        <% if @transaction.sale? %>
          <p class="text-gray-600">
            <span class="font-medium">Sale Price:</span> <%= number_to_currency(@transaction.amount) %>
          </p>
        <% end %>
        <p class="text-gray-600">
          <span class="font-medium">Type:</span> <%= @transaction.transaction_type.titleize %>
        </p>
        <p class="text-gray-600">
          <span class="font-medium">Status:</span> <%= @transaction.status.titleize %>
        </p>
      </div>
    </div>

    <!-- Parties -->
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Parties</h2>
      <div class="space-y-4">
        <div>
          <p class="text-xs text-gray-500 uppercase tracking-wide">Buyer</p>
          <p class="font-medium text-gray-900"><%= @buyer.display_name %></p>
          <p class="text-sm text-gray-500"><%= @buyer.email %></p>
          <% if @dispute.initiator == @buyer %>
            <span class="inline-block mt-1 px-2 py-0.5 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800">Initiator</span>
          <% end %>
        </div>
        <div>
          <p class="text-xs text-gray-500 uppercase tracking-wide">Seller</p>
          <p class="font-medium text-gray-900"><%= @seller.display_name %></p>
          <p class="text-sm text-gray-500"><%= @seller.email %></p>
          <% if @dispute.initiator == @seller %>
            <span class="inline-block mt-1 px-2 py-0.5 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800">Initiator</span>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Actions</h2>

      <% if @dispute.open? %>
        <%= button_to "Start Review", review_admin_dispute_path(@dispute), method: :post,
            class: "w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-500 mb-2" %>
      <% end %>

      <% if @dispute.unresolved? %>
        <div class="border-t border-gray-100 pt-4 mt-4">
          <h3 class="text-sm font-medium text-gray-700 mb-3">Resolve Dispute</h3>
          <%= form_with url: resolve_admin_dispute_path(@dispute), method: :post, class: "space-y-3" do %>
            <div>
              <label class="block text-sm text-gray-600 mb-1">Resolution</label>
              <%= select_tag :resolution, options_for_select([
                ["Select resolution...", ""],
                ["Buyer Favor (Refund)", "buyer_favor"],
                ["Seller Favor (No Refund)", "seller_favor"],
                ["Mutual Agreement", "mutual_agreement"],
                ["No Action Needed", "no_action"]
              ]), class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-rose-500", required: true %>
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">Resolution Notes</label>
              <%= text_area_tag :resolution_notes, nil,
                  class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-rose-500 min-h-[80px]",
                  placeholder: "Explain the resolution decision...",
                  required: true %>
            </div>
            <button type="submit" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-500">
              Resolve Dispute
            </button>
          <% end %>
        </div>
      <% end %>

      <% if @dispute.resolved? %>
        <div class="space-y-2">
          <%= form_with url: close_admin_dispute_path(@dispute), method: :post, class: "space-y-2" do %>
            <%= text_area_tag :admin_notes, nil,
                class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-rose-500 min-h-[60px]",
                placeholder: "Final admin notes (optional)..." %>
            <button type="submit" class="w-full px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-500">
              Close Dispute
            </button>
          <% end %>
        </div>
      <% end %>

      <% if @dispute.closed? %>
        <%= button_to "Reopen Dispute", reopen_admin_dispute_path(@dispute), method: :post,
            class: "w-full px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-500",
            data: { turbo_confirm: "Are you sure you want to reopen this dispute?" } %>
      <% end %>
    </div>

    <% if @dispute.resolved? || @dispute.closed? %>
      <!-- Resolution Summary -->
      <div class="bg-green-50 border border-green-200 rounded-lg p-6">
        <h2 class="text-lg font-semibold text-green-800 mb-2">Resolution</h2>
        <p class="font-medium text-green-700"><%= @dispute.resolution_display %></p>
        <% if @dispute.resolution_notes.present? %>
          <p class="text-sm text-green-600 mt-2"><%= @dispute.resolution_notes %></p>
        <% end %>
        <% if @dispute.admin_notes.present? %>
          <p class="text-sm text-green-600 mt-2 pt-2 border-t border-green-200">
            <span class="font-medium">Admin Notes:</span> <%= @dispute.admin_notes %>
          </p>
        <% end %>
      </div>
    <% end %>
  </div>
</div>
