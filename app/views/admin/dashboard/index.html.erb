<% content_for :page_title, "Dashboard" %>

<!-- Stats Grid -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
  <%= render 'shared/components/stat_card',
      label: "Total Users",
      value: number_with_delimiter(@total_users),
      icon: "user" %>

  <%= render 'shared/components/stat_card',
      label: "Total Listings",
      value: number_with_delimiter(@total_listings),
      icon: "tag" %>

  <%= render 'shared/components/stat_card',
      label: "Total Transactions",
      value: number_with_delimiter(@total_transactions),
      icon: "check" %>

  <%= render 'shared/components/stat_card',
      label: "Total Gift Card Value",
      value: number_to_currency(@total_gift_card_value),
      icon: "currency-dollar" %>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
  <!-- Transaction Status Chart -->
  <div class="card p-6">
    <h3 class="text-lg font-semibold text-neutral-900 mb-4">Transaction Status</h3>
    <div class="space-y-3">
      <% Transaction::STATUSES.each do |status| %>
        <% count = @transaction_stats[status] || 0 %>
        <% percentage = @total_transactions > 0 ? (count.to_f / @total_transactions * 100).round(1) : 0 %>
        <div>
          <div class="flex justify-between text-sm mb-1">
            <span class="text-neutral-600 capitalize"><%= status %></span>
            <span class="font-medium text-neutral-900"><%= count %></span>
          </div>
          <%= render 'shared/components/progress_bar',
              value: percentage,
              variant: case status
                when 'completed' then :success
                when 'pending' then :warning
                when 'countered' then :secondary
                when 'rejected' then :danger
                else :neutral
              end,
              size: :sm %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Recent Users -->
  <div class="card p-6">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-semibold text-neutral-900">Recent Users</h3>
      <%= link_to "View all", admin_users_path, class: "text-sm text-primary-600 hover:text-primary-500 font-medium" %>
    </div>
    <div class="space-y-3">
      <% @recent_users.each do |user| %>
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <%= render 'shared/components/avatar',
                name: user.display_name,
                image_url: user.avatar.presence,
                size: :sm %>
            <div class="ml-3">
              <p class="text-sm font-medium text-neutral-900"><%= user.display_name %></p>
              <p class="text-xs text-neutral-500"><%= user.email %></p>
            </div>
          </div>
          <span class="text-xs text-neutral-500"><%= time_ago_in_words(user.created_at) %> ago</span>
        </div>
      <% end %>
    </div>
  </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
  <!-- Recent Transactions -->
  <div class="card overflow-hidden">
    <div class="px-6 py-4 border-b border-neutral-100 flex items-center justify-between">
      <h3 class="text-lg font-semibold text-neutral-900">Recent Transactions</h3>
      <%= link_to "View all", admin_transactions_path, class: "text-sm text-primary-600 hover:text-primary-500 font-medium" %>
    </div>
    <div class="overflow-x-auto">
      <table class="table">
        <thead>
          <tr>
            <th>Transaction</th>
            <th>Status</th>
            <th>Amount</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-neutral-100">
          <% @recent_transactions.each do |txn| %>
            <tr>
              <td>
                <%= link_to admin_transaction_path(txn), class: "hover:text-primary-600" do %>
                  <p class="text-sm font-medium text-neutral-900"><%= txn.listing.brand_name %></p>
                  <p class="text-xs text-neutral-500"><%= txn.buyer.display_name %> â†’ <%= txn.seller.display_name %></p>
                <% end %>
              </td>
              <td>
                <%= render 'shared/components/badge',
                    text: txn.status.capitalize,
                    variant: case txn.status
                      when 'completed' then :success
                      when 'pending' then :warning
                      when 'countered' then :secondary
                      else :neutral
                    end,
                    size: :sm %>
              </td>
              <td class="text-sm font-medium text-neutral-900"><%= number_to_currency(txn.amount) if txn.amount %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Recent Listings -->
  <div class="card overflow-hidden">
    <div class="px-6 py-4 border-b border-neutral-100 flex items-center justify-between">
      <h3 class="text-lg font-semibold text-neutral-900">Recent Listings</h3>
      <%= link_to "View all", admin_listings_path, class: "text-sm text-primary-600 hover:text-primary-500 font-medium" %>
    </div>
    <div class="overflow-x-auto">
      <table class="table">
        <thead>
          <tr>
            <th>Listing</th>
            <th>Type</th>
            <th>Price</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-neutral-100">
          <% @recent_listings.each do |listing| %>
            <tr>
              <td>
                <%= link_to admin_listing_path(listing), class: "hover:text-primary-600" do %>
                  <p class="text-sm font-medium text-neutral-900"><%= listing.brand_name %></p>
                  <p class="text-xs text-neutral-500">by <%= listing.user.display_name %></p>
                <% end %>
              </td>
              <td>
                <%= render 'shared/components/badge',
                    text: listing.listing_type.capitalize,
                    variant: listing.sale? ? :success : :secondary,
                    size: :sm %>
              </td>
              <td class="text-sm font-medium text-neutral-900"><%= number_to_currency(listing.asking_price) if listing.asking_price %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>
